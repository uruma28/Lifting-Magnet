# 解体現場用リフティングマグネットアタッチメント制御システム

## プロジェクト概要

解体現場用のリフティングマグネットアタッチメントの制御用プログラムを開発します。メインマイコンにSTM32G474、RTOSにμT-Kernel3.0を採用し、BLE無線通信による操作系を実現します。

---

## 制御基板 (APB-1260)

### 概要

このプロジェクトの主制御を担う基板です。システムの起動時の構成判別や、ドーターボードまたは運転席基板とのUART通信、マグネットのON/OFF制御を行います。

### 主要コンポーネント

* **メインマイコン**: STM32G474
* **RTOS**: μT-Kernel3.0

### 主要機能

* **システム構成自動判別**:
    * 起動時にドーターボード使用/直接UART接続の2パターンを自動判別。
    * UART通信による識別要求コマンド (`"SYS_ID_REQ\r\n"`) を送信し、応答 (`"DAUGHTER_BOARD_OK\r\n"`) を監視。
    * タイムアウト時間: 100ms（ドーターボードの起動時間を考慮）。
    * 判別ロジックは以下の通り:
        * 応答あり → ドーターボード構成 (BLE+WiFi機能有効)
        * 応答なし → 直接UART構成 (運転席基板直結)
    * 通信エラー時は直接UART構成として処理。
    * 判別結果はシステムログに記録。
    * 運用中の構成変更は検出せず、再起動で再判別。
* **ドーターボード / 運転席基板との通信**:
    * UART通信による制御コマンド、ステータス情報の送受信。
    * GPIO 1本によるマグネットON/OFF制御（ドーターボードとの連携時）。
* **デバッグ機能**:
    * 判別結果やタイミング情報をログ出力し、現場での動作確認を支援。

### 実装上の注意点

* 判別用UARTコマンドは通常の制御コマンドと重複しないよう設計。
* 判別完了まで他のUART通信は待機状態とする。

---

## ドーターボード (APB-1264)

### 概要

制御基板と運転席基板間の無線通信を仲介する専用基板です。WiFiデバッグサーバー機能も提供します。

### 主要コンポーネント

* **無線通信モジュール**: XIAO ESP32S3

### 主要機能

* **制御基板との通信**:
    * UART通信による制御コマンド、ステータス情報の送受信。
    * 制御基板からの識別要求 (`"SYS_ID_REQ\r\n"`) に対して、起動完了後速やかに応答 (`"DAUGHTER_BOARD_OK\r\n"`) を返送。
* **運転席基板との通信**:
    * BLE通信（無線制御）によるオペレーター操作情報の送受信。
* **WiFiデバッグサーバー**:
    * ESP32上で動作し、デバッグ情報をスマートフォンで確認可能。

### 実装上の注意点

* 起動完了後速やかに識別要求に応答する仕様とする。

---

## 運転席基板 (APB-1263)

### 概要

オペレーターがリフティングマグネットを操作するためのインターフェースを提供する基板です。無線接続と直接接続の2パターンに対応します。

### 主要コンポーネント

* **マイコン**: XIAO ESP32S3
* **オーディオモジュール**: DFPlayer Mini (オペレーター操作時の音声フィードバック等に使用)
* **DCDCコンバータ**

### 主要機能

* **オペレーター操作受付**:
    * マグネットのON/OFF、その他制御に関するオペレーターの入力を受け付ける。
* **ドーターボード / 制御基板との通信**:
    * **ドーターボード経由時**: BLE通信によりドーターボードへ操作情報を送信。
    * **直接接続時**: UART通信により制御基板へ操作情報を直接送信。
* **音声フィードバック**:
    * DFPlayer Mini を使用し、操作状況に応じた音声ガイダンスや確認音を再生。

### 電源系統

運転席基板の電源は、外部から供給される**12Vの元電源**を使用します。この12Vは、基板上の**DCDCコンバータ**によって**3.3Vに降圧**されます。降圧された3.3Vは、**マイコン（XIAO ESP32S3）**や**オーディオモジュール（DFPlayer Mini）**、その他基板上の主要なデジタル部品に安定して供給されます。

### 実装上の注意点

* BLE通信モードと直接UART接続モードの両方に対応したソフトウェア設計が必要。

---

## 技術仕様

* **メインマイコン**: STM32G474
* **RTOS**: μT-Kernel3.0
* **無線通信モジュール**: XIAO ESP32S3
* **通信プロトコル**: UART、BLE、WiFi
* **対象環境**: 解体現場（屋外、振動環境）